<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Firefighter Ops Manager</title>
    
    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Leaflet (Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Mobile Fixes */
        input[type="file"] { font-size: 16px; } /* Prevents zoom on focus */
        .touch-btn:active { transform: scale(0.95); opacity: 0.8; }
    </style>
    
    <!-- PRELOADED DATA PLACEHOLDER -->
    <script>
        window.PRELOADED_DB = null;
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // DATA: LOCATIONS
        // ==========================================
        const LOCATIONS = {
            STATION_44: { lat: 1.373618442235897, lng: 103.75260287292423, name: "BB Fire Station" },
            CCK_POST: { lat: 1.3927844862666143, lng: 103.74695355401334, name: "Choa Chu Kang Post" },
            BT_TIMAH_POST: { lat: 1.3408184166279271, lng: 103.77162776750693, name: "Bukit Timah Post" },
            BT_PANJANG_POST: { lat: 1.376148675842668, lng: 103.77039064051998, name: "Bukit Panjang Post" }
        };

        // ==========================================
        // LOGIC: ROUTING & MATH
        // ==========================================
        const getDistance = (lat1, lng1, lat2, lng2) => {
            const R = 6371e3; 
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lng2-lng1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        const optimizeRoute = (startNode, endNode, hydrants) => {
            let current = startNode;
            let pool = [...hydrants];
            let path = [];
            while (pool.length > 0) {
                let closestIdx = -1;
                let minD = Infinity;
                for(let i=0; i<pool.length; i++){
                    const d = getDistance(current.lat, current.lng, pool[i].lat, pool[i].lng);
                    if(d < minD){ minD = d; closestIdx = i; }
                }
                if(closestIdx !== -1){
                    path.push(pool[closestIdx]);
                    current = pool[closestIdx];
                    pool.splice(closestIdx, 1);
                } else break;
            }
            return { start: startNode, waypoints: path, end: endNode };
        };

        const getEndpoints = (applianceId) => {
            const id = applianceId.toUpperCase().replace(/\s/g, '');
            const start = LOCATIONS.STATION_44;
            let end = LOCATIONS.STATION_44;
            if (id.includes("LF441E")) end = LOCATIONS.CCK_POST;
            else if (id.includes("LF442E")) end = LOCATIONS.BT_TIMAH_POST;
            else if (id.includes("LF443E")) end = LOCATIONS.BT_PANJANG_POST;
            return { start, end };
        };

        // ==========================================
        // LOGIC: PARSING
        // ==========================================
        const parseKML = (text) => {
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, "text/xml");
            const placemarks = xml.getElementsByTagName("Placemark");
            const db = {};
            let count = 0;
            for(let i=0; i<placemarks.length; i++){
                const nameNode = placemarks[i].getElementsByTagName("name")[0];
                const ptNode = placemarks[i].getElementsByTagName("Point")[0];
                if(nameNode && ptNode){
                    const rawName = nameNode.textContent.trim();
                    const key = rawName.replace(/[^a-zA-Z0-9]/g, "").toUpperCase();
                    const coordText = ptNode.getElementsByTagName("coordinates")[0].textContent.trim();
                    const [lng, lat] = coordText.split(',').map(Number);
                    if(!isNaN(lat) && !isNaN(lng)){
                        db[key] = { id: rawName, lat, lng, type: 'hydrant' };
                        count++;
                    }
                }
            }
            return { db, count };
        };

        const processExcelData = (workbook, kmlDB) => {
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            const assignments = {}; 
            let currentAppliance = "UNASSIGNED";
            let foundCount = 0;

            const APPLIANCE_REGEX = /^(PL|LF|RED|BRT|MP)\s*?\d+\w*$/i;
            // Strict Prefix with Optional R or G
            const HYDRANT_STRICT_REGEX = /^(DPH|GH|DP|H)[RG]*\s*?\d+\w*$/i;

            rows.forEach((row) => {
                // PASS 1: Appliance Detection
                row.forEach(cell => {
                    if (!cell) return;
                    const val = String(cell).trim().toUpperCase();
                    const cleanVal = val.replace(/[^A-Z0-9]/g, "");
                    if (APPLIANCE_REGEX.test(val) && !val.includes("APPLIANCE")) {
                         currentAppliance = cleanVal;
                    }
                });

                // PASS 2: Hydrant Detection
                row.forEach(cell => {
                    if (!cell) return;
                    const val = String(cell).trim().toUpperCase();
                    const cleanVal = val.replace(/[^A-Z0-9]/g, "");
                    
                    if (HYDRANT_STRICT_REGEX.test(val)) {
                        let match = null;
                        
                        // A. Exact Match
                        if (kmlDB[cleanVal]) match = kmlDB[cleanVal];
                        // B. Ignore 'R'
                        if (!match) {
                            const noR = cleanVal.replace(/R/g, "");
                            if (kmlDB[noR]) match = kmlDB[noR];
                        }
                        // C. Ignore 'G' ONLY if after 'H'
                        if (!match) {
                            const noGafterH = cleanVal.replace(/HG/g, "H");
                            if (kmlDB[noGafterH]) match = kmlDB[noGafterH];
                        }
                        // D. Combined
                        if (!match) {
                            const noR_noG = cleanVal.replace(/R/g, "").replace(/HG/g, "H");
                            if (kmlDB[noR_noG]) match = kmlDB[noR_noG];
                        }

                        if (match) {
                            if (!assignments[currentAppliance]) assignments[currentAppliance] = [];
                            const exists = assignments[currentAppliance].some(h => h.id === match.id);
                            if (!exists) {
                                assignments[currentAppliance].push(match);
                                foundCount++;
                            }
                        }
                    }
                });
            });
            return { assignments, foundCount };
        };

        // ==========================================
        // COMPONENT: APP
        // ==========================================
        const App = () => {
            const [view, setView] = useState("loading"); 
            const [db, setDb] = useState(window.PRELOADED_DB || {});
            const [routes, setRoutes] = useState({}); 
            const [selectedAppliance, setSelectedAppliance] = useState(null);
            const [excelStatus, setExcelStatus] = useState("idle");
            const [stats, setStats] = useState({ count: 0 });
            const [errorLog, setErrorLog] = useState("");
            
            const mapInstance = useRef(null);
            const markersRef = useRef([]);

            // Effect: Check DB status on mount
            useEffect(() => {
                if (Object.keys(db).length > 0) {
                    setView("dashboard");
                    return;
                }
                const stored = localStorage.getItem("kml_db_v3");
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        setDb(parsed);
                        setView("dashboard");
                    } catch(e) { setView("setup"); }
                } else {
                    setView("setup");
                }
            }, []);

            // Map Init & Rendering
            useEffect(() => {
                if (!selectedAppliance || !routes[selectedAppliance]) return;
                
                if (!mapInstance.current && document.getElementById('map-div')) {
                    mapInstance.current = L.map('map-div').setView([1.3736, 103.7526], 12);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; OpenStreetMap'
                    }).addTo(mapInstance.current);
                }
                const map = mapInstance.current;
                if(!map) return;

                const routeData = routes[selectedAppliance];
                markersRef.current.forEach(m => map.removeLayer(m));
                markersRef.current = [];
                const group = new L.featureGroup();

                const startIcon = L.divIcon({className: 'bg-transparent', html: `<div class="text-green-500 text-3xl filter drop-shadow-lg"><i class="fas fa-warehouse"></i></div>`, iconSize: [30, 30], iconAnchor: [15, 30]});
                const endIcon = L.divIcon({className: 'bg-transparent', html: `<div class="text-red-500 text-3xl filter drop-shadow-lg"><i class="fas fa-flag-checkered"></i></div>`, iconSize: [30, 30], iconAnchor: [5, 30]});

                const startM = L.marker([routeData.start.lat, routeData.start.lng], {icon: startIcon}).bindPopup(`<b>Start:</b> ${routeData.start.name}`).addTo(map);
                group.addLayer(startM);
                markersRef.current.push(startM);

                routeData.waypoints.forEach((pt, i) => {
                    const m = L.marker([pt.lat, pt.lng], {
                        icon: L.divIcon({
                            className: 'bg-transparent',
                            html: `<div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-white text-xs font-bold border-2 border-white shadow-lg">${i+1}</div>`
                        })
                    }).bindPopup(`<b>#${i+1}: ${pt.id}</b>`).addTo(map);
                    group.addLayer(m);
                    markersRef.current.push(m);
                });

                const endM = L.marker([routeData.end.lat, routeData.end.lng], {icon: endIcon}).bindPopup(`<b>End:</b> ${routeData.end.name}`).addTo(map);
                group.addLayer(endM);
                markersRef.current.push(endM);

                const latlngs = [
                    [routeData.start.lat, routeData.start.lng],
                    ...routeData.waypoints.map(p => [p.lat, p.lng]),
                    [routeData.end.lat, routeData.end.lng]
                ];
                const poly = L.polyline(latlngs, { color: '#3b82f6', weight: 4, opacity: 0.8, dashArray: '5, 10' }).addTo(map);
                group.addLayer(poly);
                markersRef.current.push(poly);
                
                map.fitBounds(group.getBounds(), { padding: [50, 50] });
            }, [selectedAppliance, routes]);

            // --- Handlers ---

            const handleKML = (e) => {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = (evt) => {
                    try {
                        const { db: newDb, count } = parseKML(evt.target.result);
                        if (count > 0) {
                            setDb(newDb);
                            localStorage.setItem("kml_db_v3", JSON.stringify(newDb));
                            setView("dashboard");
                        } else alert("Invalid KML");
                    } catch(err) { 
                        setErrorLog(err.message);
                        alert("Parse Error"); 
                    }
                };
                r.readAsText(f);
            };

            const handleExcel = async (e) => {
                if (typeof XLSX === 'undefined') {
                    setErrorLog("XLSX Library missing. Check internet.");
                    alert("Error: Excel Engine not loaded.");
                    setExcelStatus("idle");
                    return;
                }

                const file = e.target.files[0];
                if (!file) return; 
                
                setExcelStatus("processing");
                setRoutes({});
                setSelectedAppliance(null);
                setErrorLog("");

                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const { assignments, foundCount } = processExcelData(workbook, db);
                    
                    const optimizedRoutes = {};
                    Object.keys(assignments).forEach(key => {
                        const { start, end } = getEndpoints(key);
                        const hydrants = assignments[key];
                        optimizedRoutes[key] = optimizeRoute(start, end, hydrants);
                    });

                    if (foundCount === 0) {
                        setErrorLog("0 Hydrants found. Check IDs in Excel.");
                        alert("No valid hydrants found.");
                        setExcelStatus("idle");
                        return;
                    }

                    setRoutes(optimizedRoutes);
                    setStats({ count: foundCount });
                    const keys = Object.keys(optimizedRoutes);
                    if (keys.length > 0) setSelectedAppliance(keys[0]);
                    setExcelStatus("success");
                } catch (err) {
                    console.error(err);
                    setErrorLog(err.message);
                    setExcelStatus("idle");
                    alert("Excel Error: " + err.message);
                }
            };

            const openGoogleMaps = () => {
                if (!selectedAppliance) return;
                const data = routes[selectedAppliance];
                if (!data) return;
                const baseUrl = "https://www.google.com/maps/dir/?api=1";
                const origin = `&origin=${data.start.lat},${data.start.lng}`;
                const dest = `&destination=${data.end.lat},${data.end.lng}`;
                const pointsToLink = data.waypoints.slice(0, 9); 
                let waypointsParam = "";
                if (pointsToLink.length > 0) {
                    waypointsParam = "&waypoints=" + pointsToLink.map(p => `${p.lat},${p.lng}`).join('|');
                }
                const url = `${baseUrl}${origin}${dest}${waypointsParam}&travelmode=driving`;
                window.open(url, '_blank');
            };

            const handleResetSheet = () => {
                setExcelStatus('idle');
                setRoutes({});
                setSelectedAppliance(null);
                setStats({ count: 0 });
            };

            const resetDb = () => {
                if(confirm("Reset KML Database?")) {
                    localStorage.removeItem("kml_db_v3");
                    window.location.reload();
                }
            };

            const exportStandalone = () => {
                if (Object.keys(db).length === 0) {
                    alert("No database loaded to export.");
                    return;
                }
                const htmlContent = document.documentElement.outerHTML;
                const injection = `window.PRELOADED_DB = ${JSON.stringify(db)};`;
                const placeholder = "window.PRELOADED_DB = null;";
                if (!htmlContent.includes(placeholder)) {
                    alert("Error: Could not find injection point.");
                    return;
                }
                const newContent = htmlContent.replace(placeholder, injection);
                const blob = new Blob([newContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = "HydrantOps_Standalone.html";
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // --- Views ---

            if (view === "setup") {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-900 text-center">
                        <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 max-w-md w-full">
                            <i className="fas fa-fire-extinguisher text-5xl text-red-500 mb-4"></i>
                            <h1 className="text-2xl font-bold text-white mb-2">Initial Setup</h1>
                            <p className="text-slate-400 text-sm mb-6">Please upload <b>HYDHRIFSHSPBNDRY.kml</b>.</p>
                            <label className="block w-full py-4 px-6 border-2 border-dashed border-slate-600 hover:border-red-500 hover:bg-slate-700 rounded-xl cursor-pointer transition touch-btn relative">
                                <span className="text-slate-200 font-medium">Select KML File</span>
                                <input type="file" accept=".kml,.xml" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onChange={handleKML} />
                            </label>
                            {errorLog && <div className="mt-4 text-red-400 text-xs font-mono bg-black p-2 rounded">{errorLog}</div>}
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex flex-col bg-slate-900 text-white font-sans">
                    
                    {/* Header */}
                    <header className="bg-slate-800 p-3 flex justify-between items-center border-b border-slate-700 shadow-md z-30">
                        <div className="flex items-center gap-3">
                            <div className="bg-red-600 w-10 h-10 rounded-lg flex items-center justify-center shadow-lg">
                                <i className="fas fa-map-marked-alt text-xl"></i>
                            </div>
                            <div>
                                <h1 className="font-bold text-lg leading-tight">OPS MANAGER</h1>
                                <div className="text-xs text-green-400 flex items-center">
                                    <i className="fas fa-wifi mr-1 text-[10px]"></i> Online ‚Ä¢ {Object.keys(db).length} Nodes
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex gap-2 items-center">
                            <button onClick={exportStandalone} className="text-green-400 hover:text-white text-xs font-bold px-2 py-1 border border-green-900 rounded bg-green-900/20 transition touch-btn">
                                <i className="fas fa-save"></i> Save
                            </button>
                            
                            {excelStatus === 'success' && (
                                <button onClick={handleResetSheet} className="text-blue-400 hover:text-white text-xs font-bold px-2 py-1 border border-blue-900 rounded bg-blue-900/20 transition touch-btn">
                                    <i className="fas fa-file-excel"></i> New
                                </button>
                            )}
                            <button onClick={resetDb} className="text-slate-500 hover:text-red-400 p-2 touch-btn"><i className="fas fa-trash"></i></button>
                        </div>
                    </header>

                    <main className="flex-1 overflow-hidden flex flex-col relative">
                        
                        {/* TOP: File Upload / Tabs */}
                        <div className="bg-slate-800 p-4 pb-2 shadow-lg z-20">
                            {excelStatus === 'idle' && (
                                <label className="block w-full bg-slate-700 hover:bg-slate-600 text-center py-4 rounded-lg cursor-pointer transition border border-slate-600 border-dashed touch-btn relative">
                                    <i className="fas fa-file-excel mr-2 text-green-400"></i>
                                    <span className="text-sm font-medium">Upload Duty Excel</span>
                                    <input 
                                        type="file" 
                                        accept=".xlsx, .xls" 
                                        onChange={handleExcel} 
                                        onClick={(e) => {e.target.value = null}}
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" 
                                    />
                                </label>
                            )}
                            
                            {excelStatus === 'processing' && (
                                <div className="text-center py-3 text-sm text-blue-400 animate-pulse font-bold">
                                    Processing...
                                </div>
                            )}

                            {excelStatus === 'success' && (
                                <div className="mt-2">
                                    <div className="flex overflow-x-auto space-x-2 pb-2 no-scrollbar">
                                        {Object.keys(routes).map(key => (
                                            <button 
                                                key={key}
                                                onClick={() => setSelectedAppliance(key)}
                                                className={`flex-shrink-0 px-4 py-3 rounded-md text-sm font-bold transition flex items-center gap-2 border touch-btn ${selectedAppliance === key ? 'bg-blue-600 border-blue-500 text-white shadow-lg' : 'bg-slate-700 border-slate-600 text-slate-400 hover:bg-slate-600'}`}
                                            >
                                                {key === "UNASSIGNED" ? "‚ö†Ô∏è" : "üöí"} {key}
                                                <span className="bg-black/20 px-1.5 rounded text-xs">{routes[key].waypoints.length}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* MIDDLE: Map & Details */}
                        {selectedAppliance && routes[selectedAppliance] && (
                            <div className="flex-1 flex flex-col relative overflow-hidden">
                                <div className="absolute inset-0 z-0 bg-slate-900">
                                    <div id="map-div" className="w-full h-full"></div>
                                </div>
                                <div className="absolute bottom-6 right-6 z-10">
                                    <button 
                                        onClick={openGoogleMaps}
                                        className="bg-blue-600 hover:bg-blue-500 text-white rounded-full p-4 shadow-2xl flex items-center justify-center transition transform active:scale-95 border-2 border-blue-400 touch-btn"
                                    >
                                        <i className="fas fa-location-arrow text-xl"></i>
                                    </button>
                                </div>
                                <div className="absolute bottom-6 left-4 right-20 z-10 max-h-48 overflow-y-auto pr-2 pointer-events-none">
                                    <div className="bg-slate-900/90 backdrop-blur-md border border-slate-700 rounded-xl p-3 shadow-xl pointer-events-auto">
                                        <div className="flex justify-between items-center mb-2 text-xs uppercase font-bold text-slate-400">
                                            <span>Route Sequence</span>
                                            <span className="text-blue-400">
                                                <i className="fas fa-flag-checkered mr-1"></i>
                                                {routes[selectedAppliance].end.name}
                                            </span>
                                        </div>
                                        <div className="space-y-1.5">
                                            {routes[selectedAppliance].waypoints.map((pt, i) => (
                                                <div key={i} className="flex items-center gap-3 text-sm bg-black/20 p-1.5 rounded">
                                                    <span className="w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center text-[10px] font-bold">{i+1}</span>
                                                    <span className="font-mono font-bold">{pt.id}</span>
                                                    <i className="fas fa-check-circle ml-auto text-slate-600 hover:text-green-500 cursor-pointer"></i>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Error Log at Bottom */}
                        {errorLog && <div className="fixed bottom-0 w-full bg-red-900 text-white text-xs p-2 text-center z-50">{errorLog}</div>}

                        {/* Empty State */}
                        {excelStatus === 'success' && !selectedAppliance && (
                            <div className="flex-1 flex items-center justify-center text-slate-500">
                                Select an appliance to view route
                            </div>
                        )}

                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>